<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AutoStrm Configuration</title>
    <style>
        .section-header {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #00a4dc;
            border-bottom: 2px solid #00a4dc;
            padding-bottom: 5px;
        }
        .performance-info {
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .performance-info h4 {
            margin-top: 0;
            color: #0066cc;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box h4 {
            margin-top: 0;
            color: #856404;
        }
        .auto-split-options {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="AutoStrmConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="AutoStrmConfigForm">
                    <!-- Basic Configuration -->
                    <div class="section-header">Basic Configuration</div>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="BaseStrmPath">Base STRM Path</label>
                        <input id="BaseStrmPath" name="BaseStrmPath" type="text" is="emby-input" />
                        <div class="fieldDescription">The base directory where STRM files will be created (e.g., /media/strm)</div>
                    </div>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ApiEndpoint">API Endpoint</label>
                        <input id="ApiEndpoint" name="ApiEndpoint" type="text" is="emby-input" readonly />
                        <div class="fieldDescription">The API endpoint path (read-only)</div>
                    </div>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="FileNamePattern">File Name Pattern</label>
                        <input id="FileNamePattern" name="FileNamePattern" type="text" is="emby-input" />
                        <div class="fieldDescription">Pattern for naming STRM files. Use {name} for original name</div>
                    </div>

                    <!-- Media Organization -->
                    <div class="section-header">Media Organization</div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableMediaTypeDetection" name="EnableMediaTypeDetection" type="checkbox" is="emby-checkbox" />
                            <span>Enable Media Type Detection</span>
                        </label>
                        <div class="fieldDescription">Automatically detect movies vs TV series from filenames</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="OrganizeByMediaType" name="OrganizeByMediaType" type="checkbox" is="emby-checkbox" />
                            <span>Organize by Media Type</span>
                        </label>
                        <div class="fieldDescription">Automatically organize into Movies and TV Shows folders</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableParentFolders" name="EnableParentFolders" type="checkbox" is="emby-checkbox" />
                            <span>Create Parent Folders</span>
                        </label>
                        <div class="fieldDescription">Create subfolders based on parent ID from the JSON data</div>
                    </div>

                    <!-- Performance & Auto-Splitting -->
                    <div class="section-header">Performance & Auto-Splitting</div>
                    
                    <div class="performance-info">
                        <h4>üöÄ Performance Benefits</h4>
                        <p>Auto-splitting keeps folder sizes optimal for Jellyfin performance:</p>
                        <ul>
                            <li><strong>60-80% faster</strong> library scanning</li>
                            <li><strong>50-70% less</strong> memory usage</li>
                            <li><strong>No GUI freezing</strong> during scans</li>
                            <li><strong>3-5x faster</strong> search operations</li>
                        </ul>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableAutoSplit" name="EnableAutoSplit" type="checkbox" is="emby-checkbox" />
                            <span>Enable Automatic Folder Splitting</span>
                        </label>
                        <div class="fieldDescription">Automatically split folders to optimize Jellyfin performance</div>
                    </div>

                    <div class="auto-split-options" id="autoSplitOptions" style="display: none;">
                        <div class="selectContainer">
                            <label class="selectLabel" for="AutoSplitMode">Auto-Split Mode</label>
                            <select is="emby-select" id="AutoSplitMode" name="AutoSplitMode" class="emby-select-withcolor emby-select">
                                <option value="0">Disabled</option>
                                <option value="1">Alphabetical (A-C, D-F, etc.)</option>
                                <option value="2">Smart (recommended)</option>
                                <option value="3">Genre-based</option>
                            </select>
                            <div class="fieldDescription">Choose how folders should be automatically organized</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MaxFilesPerFolder">Max Files Per Folder</label>
                            <input id="MaxFilesPerFolder" name="MaxFilesPerFolder" type="number" is="emby-input" min="100" max="500" />
                            <div class="fieldDescription">Maximum files per folder before splitting (recommended: 400, max safe: 450)</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="EnablePerformanceOptimizations" name="EnablePerformanceOptimizations" type="checkbox" is="emby-checkbox" />
                                <span>Enable Performance Optimizations</span>
                            </label>
                            <div class="fieldDescription">Enable additional optimizations for large libraries</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="LogFolderStatistics" name="LogFolderStatistics" type="checkbox" is="emby-checkbox" />
                                <span>Log Folder Statistics</span>
                            </label>
                            <div class="fieldDescription">Log folder sizes and split operations for monitoring</div>
                        </div>
                    </div>

                    <div class="warning-box" id="folderLimitWarning" style="display: none;">
                        <h4>‚ö†Ô∏è Folder Limit Warning</h4>
                        <p>Jellyfin experiences performance issues with folders containing more than 500 files. Auto-splitting prevents these issues by keeping folders under the configured limit.</p>
                    </div>

                    <!-- Advanced Options -->
                    <div class="section-header">Advanced Options</div>
                    
                    <div class="selectContainer">
                        <label class="selectLabel" for="DuplicateHandling">Duplicate Handling</label>
                        <select is="emby-select" id="DuplicateHandling" name="DuplicateHandling" class="emby-select-withcolor emby-select">
                            <option value="0">Overwrite</option>
                            <option value="1">Skip</option>
                            <option value="2">Create Versions</option>
                        </select>
                        <div class="fieldDescription">How to handle duplicate files when same data is sent again</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableLogging" name="EnableLogging" type="checkbox" is="emby-checkbox" />
                            <span>Enable Detailed Logging</span>
                        </label>
                        <div class="fieldDescription">Enable detailed logging for debugging purposes</div>
                    </div>

                    <!-- Usage Instructions -->
                    <div class="section-header">Usage Instructions</div>
                    
                    <div class="detailsText">
                        <p>This plugin creates STRM files from JSON data received via POST requests.</p>
                        <p><strong>Webhook URL:</strong> <code>http://your-jellyfin-server:port/plugins/autostrm/webhook</code></p>
                        <p><strong>Health Check:</strong> <code>http://your-jellyfin-server:port/plugins/autostrm/health</code></p>
                        <p>Send JSON data with the following structure:</p>
                        <pre><code>{
    "code": 0,
    "data": [
        {
            "url": "https://example.com/video.mp4",
            "name": "Video Name.mp4",
            "parent": 123
        }
    ],
    "msg": ""
}</code></pre>
                        <p><strong>File Organization with Auto-Split:</strong></p>
                        <ul>
                            <li>Movies: <code>/Movies/A-C/Movie Name (2023).strm</code></li>
                            <li>TV Shows: <code>/TV Shows/Series Name/Season 01/Episode.strm</code></li>
                            <li>Large Seasons: <code>/TV Shows/Series/Season 01/Episodes 001-100/Episode.strm</code></li>
                        </ul>
                        <p><strong>Note:</strong> You may need to manually trigger a library scan in Jellyfin to see new files.</p>
                    </div>
                    
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save Configuration</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var AutoStrmConfig = {
                pluginUniqueId: 'eb5d7894-8eef-4b36-aa6f-5d124e828ce1'
            };

            function toggleAutoSplitOptions() {
                var enableAutoSplit = document.querySelector('#EnableAutoSplit').checked;
                var autoSplitOptions = document.querySelector('#autoSplitOptions');
                var folderWarning = document.querySelector('#folderLimitWarning');
                
                if (enableAutoSplit) {
                    autoSplitOptions.style.display = 'block';
                    folderWarning.style.display = 'none';
                } else {
                    autoSplitOptions.style.display = 'none';
                    folderWarning.style.display = 'block';
                }
            }

            function updateMaxFilesWarning() {
                var maxFiles = parseInt(document.querySelector('#MaxFilesPerFolder').value);
                var warning = document.querySelector('#folderLimitWarning');
                
                if (maxFiles > 450) {
                    warning.style.display = 'block';
                    warning.innerHTML = '<h4>‚ö†Ô∏è Performance Warning</h4><p>Values above 450 may cause performance issues in Jellyfin. Consider using 400 or lower for optimal performance.</p>';
                } else {
                    warning.style.display = 'none';
                }
            }

            document.querySelector('#AutoStrmConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(AutoStrmConfig.pluginUniqueId).then(function (config) {
                        // Basic configuration
                        document.querySelector('#BaseStrmPath').value = config.BaseStrmPath || '/media/strm';
                        document.querySelector('#ApiEndpoint').value = config.ApiEndpoint || '/plugins/autostrm/webhook';
                        document.querySelector('#FileNamePattern').value = config.FileNamePattern || '{name}';
                        
                        // Media organization
                        document.querySelector('#EnableLogging').checked = config.EnableLogging || false;
                        document.querySelector('#EnableParentFolders').checked = config.EnableParentFolders || false;
                        document.querySelector('#EnableMediaTypeDetection').checked = config.EnableMediaTypeDetection !== false; // Default true
                        document.querySelector('#OrganizeByMediaType').checked = config.OrganizeByMediaType !== false; // Default true
                        document.querySelector('#DuplicateHandling').value = config.DuplicateHandling || 0;
                        
                        // Auto-splitting options
                        document.querySelector('#EnableAutoSplit').checked = config.EnableAutoSplit !== false; // Default true
                        document.querySelector('#AutoSplitMode').value = config.AutoSplitMode || 2; // Default Smart
                        document.querySelector('#MaxFilesPerFolder').value = config.MaxFilesPerFolder || 400;
                        document.querySelector('#EnablePerformanceOptimizations').checked = config.EnablePerformanceOptimizations !== false; // Default true
                        document.querySelector('#LogFolderStatistics').checked = config.LogFolderStatistics || false;
                        
                        // Set up event listeners
                        document.querySelector('#EnableAutoSplit').addEventListener('change', toggleAutoSplitOptions);
                        document.querySelector('#MaxFilesPerFolder').addEventListener('input', updateMaxFilesWarning);
                        
                        // Initialize UI state
                        toggleAutoSplitOptions();
                        updateMaxFilesWarning();
                        
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#AutoStrmConfigForm')
                .addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(AutoStrmConfig.pluginUniqueId).then(function (config) {
                    // Basic configuration
                    config.BaseStrmPath = document.querySelector('#BaseStrmPath').value;
                    config.ApiEndpoint = document.querySelector('#ApiEndpoint').value;
                    config.FileNamePattern = document.querySelector('#FileNamePattern').value;
                    
                    // Media organization
                    config.EnableLogging = document.querySelector('#EnableLogging').checked;
                    config.EnableParentFolders = document.querySelector('#EnableParentFolders').checked;
                    config.EnableMediaTypeDetection = document.querySelector('#EnableMediaTypeDetection').checked;
                    config.OrganizeByMediaType = document.querySelector('#OrganizeByMediaType').checked;
                    config.DuplicateHandling = parseInt(document.querySelector('#DuplicateHandling').value);
                    
                    // Auto-splitting options
                    config.EnableAutoSplit = document.querySelector('#EnableAutoSplit').checked;
                    config.AutoSplitMode = parseInt(document.querySelector('#AutoSplitMode').value);
                    config.MaxFilesPerFolder = parseInt(document.querySelector('#MaxFilesPerFolder').value);
                    config.EnablePerformanceOptimizations = document.querySelector('#EnablePerformanceOptimizations').checked;
                    config.LogFolderStatistics = document.querySelector('#LogFolderStatistics').checked;
                    
                    ApiClient.updatePluginConfiguration(AutoStrmConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });

                e.preventDefault();
                return false;
            });
        </script>
    </div>
</body>
</html>