<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AutoStrm Configuration</title>
</head>
<body>
    <div id="AutoStrmConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="AutoStrmConfigForm">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="BaseStrmPath">Base STRM Path</label>
                        <input id="BaseStrmPath" name="BaseStrmPath" type="text" is="emby-input" />
                        <div class="fieldDescription">The base directory where STRM files will be created (e.g., /media/strm)</div>
                    </div>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ApiEndpoint">API Endpoint</label>
                        <input id="ApiEndpoint" name="ApiEndpoint" type="text" is="emby-input" readonly />
                        <div class="fieldDescription">The API endpoint path (read-only)</div>
                    </div>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="FileNamePattern">File Name Pattern</label>
                        <input id="FileNamePattern" name="FileNamePattern" type="text" is="emby-input" />
                        <div class="fieldDescription">Pattern for naming STRM files. Use {name} for original name</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableLogging" name="EnableLogging" type="checkbox" is="emby-checkbox" />
                            <span>Enable Detailed Logging</span>
                        </label>
                        <div class="fieldDescription">Enable detailed logging for debugging purposes</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableParentFolders" name="EnableParentFolders" type="checkbox" is="emby-checkbox" />
                            <span>Create Parent Folders</span>
                        </label>
                        <div class="fieldDescription">Create subfolders based on parent ID from the JSON data</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableMediaTypeDetection" name="EnableMediaTypeDetection" type="checkbox" is="emby-checkbox" />
                            <span>Enable Media Type Detection</span>
                        </label>
                        <div class="fieldDescription">Automatically detect movies vs TV series from filenames</div>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="OrganizeByMediaType" name="OrganizeByMediaType" type="checkbox" is="emby-checkbox" />
                            <span>Organize by Media Type</span>
                        </label>
                        <div class="fieldDescription">Automatically organize into Movies and TV Shows folders</div>
                    </div>
                    
                    <div class="selectContainer">
                        <label class="selectLabel" for="DuplicateHandling">Duplicate Handling</label>
                        <select is="emby-select" id="DuplicateHandling" name="DuplicateHandling" class="emby-select-withcolor emby-select">
                            <option value="0">Overwrite</option>
                            <option value="1">Skip</option>
                            <option value="2">Create Versions</option>
                        </select>
                        <div class="fieldDescription">How to handle duplicate files when same data is sent again</div>
                    </div>
                    
                    <div class="detailsText">
                        <h3>Usage Instructions</h3>
                        <p>This plugin creates STRM files from JSON data received via POST requests.</p>
                        <p><strong>Webhook URL:</strong> <code>http://your-jellyfin-server:port/plugins/autostrm/webhook</code></p>
                        <p><strong>Health Check:</strong> <code>http://your-jellyfin-server:port/plugins/autostrm/health</code></p>
                        <p>Send JSON data with the following structure:</p>
                        <pre><code>{
    "code": 0,
    "data": [
        {
            "url": "https://example.com/video.mp4",
            "name": "Video Name.mp4",
            "parent": 123
        }
    ],
    "msg": ""
}</code></pre>
                        <p><strong>File Organization:</strong></p>
                        <ul>
                            <li>Movies: <code>/Movies/Movie Name.strm</code></li>
                            <li>TV Shows: <code>/TV Shows/Series Name/Season XX/Episode.strm</code></li>
                        </ul>
                        <p><strong>Note:</strong> You may need to manually trigger a library scan in Jellyfin to see new files.</p>
                    </div>
                    
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var AutoStrmConfig = {
                pluginUniqueId: 'eb5d7894-8eef-4b36-aa6f-5d124e828ce1'
            };

            document.querySelector('#AutoStrmConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(AutoStrmConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#BaseStrmPath').value = config.BaseStrmPath || '/media/strm';
                        document.querySelector('#ApiEndpoint').value = config.ApiEndpoint || '/plugins/autostrm/webhook';
                        document.querySelector('#FileNamePattern').value = config.FileNamePattern || '{name}';
                        document.querySelector('#EnableLogging').checked = config.EnableLogging || false;
                        document.querySelector('#EnableParentFolders').checked = config.EnableParentFolders || false;
                        document.querySelector('#EnableMediaTypeDetection').checked = config.EnableMediaTypeDetection || true;
                        document.querySelector('#OrganizeByMediaType').checked = config.OrganizeByMediaType || true;
                        document.querySelector('#DuplicateHandling').value = config.DuplicateHandling || 0;
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#AutoStrmConfigForm')
                .addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(AutoStrmConfig.pluginUniqueId).then(function (config) {
                    config.BaseStrmPath = document.querySelector('#BaseStrmPath').value;
                    config.ApiEndpoint = document.querySelector('#ApiEndpoint').value;
                    config.FileNamePattern = document.querySelector('#FileNamePattern').value;
                    config.EnableLogging = document.querySelector('#EnableLogging').checked;
                    config.EnableParentFolders = document.querySelector('#EnableParentFolders').checked;
                    config.EnableMediaTypeDetection = document.querySelector('#EnableMediaTypeDetection').checked;
                    config.OrganizeByMediaType = document.querySelector('#OrganizeByMediaType').checked;
                    config.DuplicateHandling = document.querySelector('#DuplicateHandling').value;
                    
                    ApiClient.updatePluginConfiguration(AutoStrmConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });

                e.preventDefault();
                return false;
            });
        </script>
    </div>
</body>
</html>
